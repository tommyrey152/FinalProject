{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <h2>Inventory</h2>
    <div class="table-responsive">
        <table class="table">
            <thead class="thead-dark">
                <tr>
                    <th>Product</th>
                    <th>Type</th>
                    <th>Quantity</th>
                    <th>Price</th>
                    <th>Image</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for product in products %}
                <tr data-id="{{ product.id }}">
                    <td>{{ product.productName }}</td>
                    <td>{{ product.productType }}</td>
                    <td>
                        <span class="quantity-display">{{ product.quantity }}</span>
                        <input type="number" class="quantity-input form-control" value="{{ product.quantity }}" style="display: none;">
                    </td>
                    <td>${{ product.price }}</td>
                    <td><img src="{{ product.image.url }}" alt="{{ product.productName }}" style="max-width: 100px;"></td>
                    <td>
                        <button class="btn btn-primary edit-button">Edit</button>
                        <button class="btn btn-success save-button" style="display: none;">Save</button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6">No products found in inventory.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<input type="hidden" id="csrfToken" value="{{ csrf_token }}">

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    $('.edit-button').click(function() {
        let parentRow = $(this).closest('tr');
        parentRow.find('.quantity-display').hide();
        parentRow.find('.quantity-input').show().focus();
        $(this).siblings('.save-button').show();
        $(this).hide();
    });

    $('.save-button').click(function() {
        let parentRow = $(this).closest('tr');
        let productId = parentRow.data('id');
        let newQuantity = parentRow.find('.quantity-input').val();
        let buttonContext = $(this); // Preserve the button context outside of the AJAX call

        $.ajax({
            url: '{% url "update_quantity" 0 %}'.replace('0', productId),
            type: 'POST',
            data: {
                'quantity': newQuantity,
                'csrfmiddlewaretoken': $('#csrfToken').val()
            },
            success: (response) => { // Use arrow function here
                parentRow.find('.quantity-display').text(response.new_quantity).show();
                parentRow.find('.quantity-input').hide();
                parentRow.find('.edit-button').show();
                buttonContext.hide(); // Use preserved context
            },
            error: () => {
                alert('Failed to update quantity.');
            }
        });
    });
});
</script>
{% endblock %}
